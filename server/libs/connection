--Server connection stuff:

connections = {}

function handle(ID, message, protocol)
	if protocol == "far:init_connection" and message == "init_connection" then
		handleIncomingConnection(ID, _GLOBAL_TIMEOUT)
	end
end

function handleIncomingConnection(ID, timeout)
	log.info("Incoming connection from /"..ID)
	local connection = {
		client_id = ID,
		authenticated = false,
		session_id = #connections + 1
	}
	connections[#connections + 1] = connection
	rednet.send(ID, 
		{
			sessionId = connection.session_id,
			message = "ok:request_credentials"
		}, "far:init_connection"
	)
	response = assert(waitForMessage(ID, "far:init_connection:"..connection.session_id, timeout), "Connection with /"..ID.." timed out")
	assert(response.username and response.passwd)
	
end

function waitForMessage(ID, protocol, timeout)
	while true do
		local senderId, message, protocol = rednet.receive(protocol, timeout)
		if not senderId then log.error("Connection with client ID:"..ID.." timed out.")
			break
		end
		if senderId == ID then
			return message
		end
	end
end