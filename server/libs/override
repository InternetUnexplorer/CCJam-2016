function hookFile(file, old, new)
	local loaded, name = {}, fs.getName(file)
	old[name] = {}
	local ok, err = loadfile( file, loaded )
    if ok then
        local ok, err = pcall(ok)
        if not ok then
            loglib.fatal("Error loading hooks for '"..name.."':\n"..err)
            return false
        end
    else
        loglib.fatal("Error loading hooks for '"..name.."':\n"..err)
        return false
    end
    for k,v in pairs( new[name] ) do
        if k ~= "_ENV" then
            old[name][k] = new[name][k]
            if loaded[k] then
            	loglib.debug("Hooking function "..name.."."..k.."()")
            	new[name][k] = function (...)
            		setfenv( loaded[k], new )
           			loaded[k](old[name], ...)
            	end
            end
        end
    end  
    return true
end

function hook(dir, _OLD_ENV, _NEW_ENV)
	local files = fs.list(dir)
	loglib.info("Loading hooks...")
	for i, file in pairs(files) do
		hookFile(dir..file, _OLD_ENV, _NEW_ENV)
	end
end

function unhook(_OLD_ENV, _NEW_ENV)
	loglib.info("Unloading hooks...")
	for k, v in pairs( _OLD_ENV ) do
		for n, c in pairs( _OLD_ENV[k] ) do
			if _NEW_ENV[k][n] ~= _OLD_ENV[k][n] then
				loglib.debug("Unhooking "..k.."."..n.."()")
				_NEW_ENV[k][n] = _OLD_ENV[k][n]
			end
		end
	end
end